---
layout: default
title: Diary
permalink: /diary/
---

<link rel="stylesheet" href="{{ site.baseurl }}/assets/css/diary.css">

<div class="diary container">
  <!-- 3D Book Shelf -->
  <section class="book-shelf" aria-label="Members">
    <div class="shelf-rail" id="shelfRail"></div>
  </section>
</div>

<script>
/* 全エントリ（昇順）をJSへ埋め込み */
const ENTRIES = [
{% assign entries_all = site.diary | sort: 'date' %}
{% for p in entries_all %}
  { a: "{{ p.author | downcase }}", d: "{{ p.date | date: '%Y-%m-%d' }}", u: "{{ p.url | relative_url }}", t: {{ p.title | jsonify }} }{% unless forloop.last %},{% endunless %}
{% endfor %}
];

(function(){
  const shelfRail = document.getElementById('shelfRail');

  const entriesOf = (author) =>
    ENTRIES.filter(e => e.a === author).sort((x,y)=> x.d.localeCompare(y.d));

  function hueFrom(str){
    let h = 0; for (let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i)) >>> 0;
    return h % 360;
  }
  const lettersHTML = (s) => (s||'?').split('').map(c=>`<span class="ch">${c}</span>`).join('');

  fetch('{{ site.baseurl }}/assets/data/members.json', {cache:'no-store'})
    .then(r => r.json())
    .then(list => {
      list.forEach(m => {
        // 複数の候補から username を決める（堅牢化）
        const link = (m.github_link || m.github || '');
        const parts = link.split('/').filter(Boolean);
        const fromLink = parts[parts.length-1] || '';
        const raw = (m.username || fromLink || m.name || m.login || '').toString().trim();
        const username = raw.replace(/^@/, '').toLowerCase();
        // 表示用ラベルは最大 12 文字に切る（CSS と合わせて安全側で調整）
        const displayLabel = (username || 'unknown').slice(0, 12);

        const btn = document.createElement('button');
        btn.className = 'book';
        btn.dataset.username = username || ''; // 空でも本は表示される（クリック時は無視）
        btn.title = m.name || username || 'unknown';
        const h = hueFrom(displayLabel);
        btn.innerHTML = `
          <span class="book-spine" style="--h:${h}">
            <span class="book-title">${lettersHTML(displayLabel)}</span>
          </span>`;
        shelfRail.appendChild(btn);
      });
    });

  shelfRail.addEventListener('click', (e)=>{
    const btn = e.target.closest('.book');
    if(!btn) return;
    const author = btn.dataset.username;
    if(!author) return;
    const list = entriesOf(author);
    if(list.length === 0) return;
    location.href = list[0].u;
  });
})();
</script>